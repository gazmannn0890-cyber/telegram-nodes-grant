name: Generate Screenshots

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  generate-screenshots:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install dependencies
      run: |
        npm install puppeteer html2canvas jsdom
        
    - name: Create screenshot script
      run: |
        cat > generate.js << 'EOF'
        const puppeteer = require('puppeteer');
        const fs = require('fs');
        const path = require('path');

        // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
        const screenshotsDir = path.join(__dirname, 'screenshots');
        if (!fs.existsSync(screenshotsDir)) {
          fs.mkdirSync(screenshotsDir, { recursive: true });
        }

        async function takeScreenshot(page, name, options = {}) {
          const filePath = path.join(screenshotsDir, `${name}.png`);
          await page.screenshot({ 
            path: filePath,
            fullPage: true,
            ...options
          });
          console.log(`‚úÖ –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–Ω—à–æ—Ç: ${name}.png`);
        }

        async function main() {
          console.log('üöÄ –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤...');
          
          const browser = await puppeteer.launch({
            headless: 'new',
            args: ['--no-sandbox', '--disable-setuid-sandbox']
          });
          
          const page = await browser.newPage();
          await page.setViewport({ width: 1200, height: 800 });
          
          // –û—Ç–∫—Ä—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
          const htmlPath = path.join(__dirname, 'index.html');
          await page.goto(`file://${htmlPath}`, { waitUntil: 'networkidle0' });
          
          // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏
          await page.waitForSelector('.container');
          await page.waitForTimeout(2000);
          
          // 1. –û—Å–Ω–æ–≤–Ω–æ–π –≤–∏–¥ (–¥–µ–Ω—å)
          console.log('üì∏ –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç: main_day.png');
          await takeScreenshot(page, 'main_day');
          
          // 2. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –Ω–æ—á–Ω—É—é —Ç–µ–º—É
          await page.click('.theme-btn[data-theme="night"]');
          await page.waitForTimeout(1000);
          console.log('üåô –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç: main_night.png');
          await takeScreenshot(page, 'main_night');
          
          // 3. –í–æ–∑–≤—Ä–∞—â–∞–µ–º –¥–Ω–µ–≤–Ω—É—é —Ç–µ–º—É
          await page.click('.theme-btn[data-theme="day"]');
          await page.waitForTimeout(500);
          
          // 4. –û—Ç–∫—Ä—ã–≤–∞–µ–º GameZone
          await page.click('.node-item[data-node="game"]');
          await page.waitForTimeout(1000);
          console.log('üéÆ –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç: gamezone.png');
          await takeScreenshot(page, 'gamezone');
          
          // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω–∏—è —É–∑–ª–∞
          await page.click('.add-node');
          await page.waitForTimeout(1000);
          console.log('‚ûï –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç: create_node.png');
          await takeScreenshot(page, 'create_node');
          
          // 6. –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–∞–Ω–µ–ª—å —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º FamilyHub
          await page.click('.btn-secondary');
          await page.click('.node-item[data-node="family"]');
          await page.waitForTimeout(1000);
          console.log('üè† –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç: familyhub.png');
          await takeScreenshot(page, 'familyhub');
          
          // 7. Quick Switch —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
          await page.click('.switch-item:nth-child(3)'); // GameZone filter
          await page.waitForTimeout(800);
          console.log('üîç –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–Ω—à–æ—Ç: quick_switch.png');
          await takeScreenshot(page, 'quick_switch', { clip: { x: 280, y: 100, width: 600, height: 600 } });
          
          await browser.close();
          console.log('üéâ –í—Å–µ —Å–∫—Ä–∏–Ω—à–æ—Ç—ã —Å–æ–∑–¥–∞–Ω—ã!');
          
          // –°–æ–∑–¥–∞–µ–º HTML –≥–∞–ª–µ—Ä–µ—é –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
          createGallery();
        }

        function createGallery() {
          const files = fs.readdirSync(screenshotsDir).filter(f => f.endsWith('.png'));
          
          const html = `
          <!DOCTYPE html>
          <html>
          <head>
            <title>Telegram Nodes - –°–∫—Ä–∏–Ω—à–æ—Ç—ã</title>
            <style>
              body { font-family: -apple-system, sans-serif; padding: 40px; background: #f5f5f7; }
              h1 { color: #0088cc; margin-bottom: 40px; }
              .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
              .screenshot { background: white; border-radius: 16px; padding: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
              .screenshot img { width: 100%; border-radius: 8px; margin-bottom: 15px; }
              .screenshot h3 { margin: 0 0 10px 0; color: #1d1d1f; }
              .screenshot p { color: #6d6d72; font-size: 14px; margin: 0; }
              .download-btn { display: inline-block; margin-top: 15px; padding: 10px 20px; background: #0088cc; color: white; text-decoration: none; border-radius: 8px; }
            </style>
          </head>
          <body>
            <h1>üì∏ Telegram Nodes - –°–∫—Ä–∏–Ω—à–æ—Ç—ã –¥–ª—è –∫–æ–Ω–∫—É—Ä—Å–∞</h1>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString()}</p>
            <div class="gallery">
              ${files.map(file => `
                <div class="screenshot">
                  <img src="${file}" alt="${file}">
                  <h3>${file.replace('.png', '').replace('_', ' ')}</h3>
                  <p>–†–∞–∑–º–µ—Ä: ${Math.round(fs.statSync(path.join(screenshotsDir, file)).size / 1024)} KB</p>
                  <a href="${file}" class="download-btn" download>–°–∫–∞—á–∞—Ç—å PNG</a>
                </div>
              `).join('')}
            </div>
          </body>
          </html>
          `;
          
          fs.writeFileSync(path.join(screenshotsDir, 'index.html'), html);
          console.log('üìÅ –°–æ–∑–¥–∞–Ω–∞ –≥–∞–ª–µ—Ä–µ—è: screenshots/index.html');
        }

        main().catch(console.error);
        EOF
    
    - name: Run screenshot generation
      run: node generate.js
    
    - name: Upload screenshots as artifact
      uses: actions/upload-artifact@v3
      with:
        name: telegram-nodes-screenshots
        path: screenshots/
        
    - name: Commit and push screenshots
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add screenshots/
        git commit -m "ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å–∫—Ä–∏–Ω—à–æ—Ç—ã" || echo "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        git push origin main
